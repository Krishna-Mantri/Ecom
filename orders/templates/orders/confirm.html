{% extends "base.html" %}

{% block title %}
Order Confirmation
{% endblock %}

{% block content %}
<div class="container mx-auto p-6 bg-gray-50">
    <div class="flex flex-col lg:flex-row gap-8">

        <!-- Order Details Section -->
        <div class="flex flex-col w-full lg:w-2/3 space-y-6">
            <!-- Order Information -->
            <div class="shadow-lg p-6 rounded-lg bg-white border border-gray-200">
                <h2 class="text-3xl font-bold text-center text-indigo-600 mb-4">Order Confirmation</h2>
                <div class="text-lg">
                    <p><strong class="text-gray-700">Order ID:</strong> #{{ order.id }}</p>
                    <p><strong class="text-gray-700">Customer:</strong> {{ order.full_name }}</p>
                    <p><strong class="text-gray-700">Email:</strong> {{ order.email }}</p>
                    <p><strong class="text-gray-700">Address:</strong> {{ order.address }}</p>
                    <p><strong class="text-gray-700">Order Date:</strong> {{ order.created_at }}</p>
                </div>
            </div>

            <!-- Items in Your Order -->
            <div class="shadow-lg p-6 rounded-lg bg-white border border-gray-200">
                <h3 class="text-2xl font-semibold text-indigo-600 mb-4">Items in Your Order:</h3>
                <ul class="space-y-4">
                    {% for item in order.items.all %}
                    <li class="flex justify-between">
                        <span class="font-medium">{{ item.quantity }} x {{ item.product.name }}</span>
                        <span class="text-gray-600">Price: INR {{ item.price }}</span>
                        <span class="text-gray-600">Subtotal: INR {{ item.get_cost }}</span>
                    </li>
                    {% endfor %}
                </ul>
                <div class="mt-4 text-right font-semibold text-xl">
                    <p class="text-gray-800">Total: INR {{ order.get_total_cost }}</p>
                </div>
            </div>

            <!-- Payment Section -->
            <div class="shadow-lg p-6 rounded-lg bg-white border border-gray-200">
                {% if not order.paid %}
                <h3 class="text-2xl font-semibold text-indigo-600 mb-4">Complete Your Payment</h3>
                <p class="text-lg text-gray-700 mb-4">Please click the button below to complete the payment for your order.</p>
                <button id="rzp-button" class="w-full p-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300">Pay Now</button>
                <div id="loading-message" class="hidden text-center text-blue-500 mt-4">Processing your payment, please wait...</div>
                {% else %}
                <p class="text-lg font-medium text-green-600">Payment Status: Paid</p>
                {% endif %}
            </div>
        </div>

        <!-- Product Images Section -->
        <div class="hidden lg:block w-full lg:w-1/3 space-y-6">
            <div class="bg-rose-100 p-6 rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-4">Your Products</h3>
                <ul class="space-y-4">
                    {% for item in order.items.all %}
                    <li class="flex items-center space-x-4">
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-20 h-20 object-contain rounded-md border border-gray-300">
                        <span class="text-gray-800 font-semibold">{{ item.product.name }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    var options = {
        "key": "{{ razorpay_key_id }}",  // Razorpay Key ID from Django settings
        "amount": "{{ order.get_total_cost_paisa }}",  // Total amount in paisa
        "currency": "INR",
        "name": "Your Company",
        "description": "Order #{{ order.id }}",
        "order_id": "{{ order.razorpay_order_id }}",  // Razorpay order ID
        "handler": function (response) {
            // Show loading message
            document.getElementById("loading-message").classList.remove("hidden");

            // Post payment details to the server for verification
            fetch("{% url 'orders:order_confirmation' order.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(response)
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading message
                document.getElementById("loading-message").classList.add("hidden");

                if (data.status === "Payment successful") {
                    alert("Payment successful! Thank you for your order.");
                    window.location.href="{% url 'products:product_list' %}";  // Redirect to list page
                } else {
                    alert("Payment verification failed. Please try again or contact support.");
                }
            })
            .catch(error => {
                console.error("Payment Error:", error);
                alert("An unexpected error occurred during payment. Please try again later.");
                // Hide loading message
                document.getElementById("loading-message").classList.add("hidden");
            });
        },
        "prefill": {
            "name": "{{ order.full_name }}",
            "email": "{{ order.email }}",
            "contact": ""  // Add if you collect contact number
        },
        "theme": {
            "color": "#F37254"
        },
        "modal": {
            "ondismiss": function () {
                alert("Payment process was cancelled. Please try again.");
            }
        }
    };

    var rzp1 = new Razorpay(options);
    document.getElementById('rzp-button').onclick = function (e) {
        rzp1.open();
        e.preventDefault();
    };
</script>

{% endblock %}
